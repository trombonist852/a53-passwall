name: cortexa53-PassWall Auto-Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´8ç‚¹æ£€æŸ¥æ›´æ–°
    - cron: '0 0 * * *'

env:
  SDK_URL: https://downloads.openwrt.org/releases/21.02.3/targets/mvebu/cortexa53/openwrt-sdk-21.02.3-mvebu-cortexa53_gcc-8.4.0_musl.Linux-x86_64.tar.xz
  CONFIG_FILE: config/a53.config

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
    steps:
    - name: Check for PassWall updates
      id: check
      run: |
        # è·å–å½“å‰æäº¤å’Œä¸Šæ¸¸æœ€æ–°æäº¤
        CURRENT_HASH=$(git ls-remote https://github.com/xiaorouji/openwrt-passwall.git HEAD | cut -f1)
        UPSTREAM_HASH=$(curl -s https://api.github.com/repos/xiaorouji/openwrt-passwall/commits/main | jq -r '.sha')
        
        # æ¯”è¾ƒæ˜¯å¦æœ‰æ›´æ–°
        if [ "$CURRENT_HASH" != "$UPSTREAM_HASH" ]; then
          echo "has_update=true" >> $GITHUB_OUTPUT
          echo "å‘ç°PassWallæ›´æ–°: $CURRENT_HASH â†’ $UPSTREAM_HASH"
        else
          echo "has_update=false" >> $GITHUB_OUTPUT
          echo "PassWallå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi

  build:
    needs: check-updates
    if: ${{ needs.check-updates.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Get version info
      id: version
      run: |
        # ä»PassWall Makefileè·å–ç‰ˆæœ¬å·
        VERSION=$(curl -s https://raw.githubusercontent.com/xiaorouji/openwrt-passwall/main/luci-app-passwall/Makefile | grep 'PKG_VERSION:=' | cut -d= -f2 | tr -d ' ')
        
        # ç”Ÿæˆæ„å»ºæ—¶é—´ (åŒ—äº¬æ—¶é—´)
        BUILD_DATE=$(TZ='Asia/Shanghai' date +'%Y.%m.%d-%H%M')
        
        # ç»„åˆå®Œæ•´ç‰ˆæœ¬å·
        FULL_VERSION="${VERSION}.${BUILD_DATE}"
        
        echo "PassWallç‰ˆæœ¬: $VERSION"
        echo "ç¼–è¯‘æ—¶é—´: $BUILD_DATE"
        echo "å®Œæ•´ç‰ˆæœ¬: $FULL_VERSION"
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
        echo "RELEASE_TAG=v$FULL_VERSION" >> $GITHUB_ENV

    - name: Setup environment
      run: |
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        
    - name: Download OpenWrt SDK
      run: |
        wget ${{ env.SDK_URL }} -O sdk.tar.xz
        mkdir -p openwrt
        tar -xvJf sdk.tar.xz -C openwrt --strip-components=1

    - name: Configure feeds
      run: |
        cd openwrt
        echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> feeds.conf.default
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Build PassWall
      run: |
        cd openwrt
        make defconfig
        [ -e ${{ github.workspace }}/${{ env.CONFIG_FILE }} ] && \
        mv ${{ github.workspace }}/${{ env.CONFIG_FILE }} .config
        
        # åªç¼–è¯‘PassWallç›¸å…³åŒ…
        make package/luci-app-passwall/compile -j$(nproc) V=s

    - name: Collect PassWall artifacts
      run: |
        # åˆ›å»ºä¸“ç”¨ç›®å½•å­˜æ”¾PassWallæ–‡ä»¶
        mkdir -p ${{ github.workspace }}/passwall-artifacts
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp ${{ github.workspace }}/openwrt/bin/packages/*/passwall/*.ipk ${{ github.workspace }}/passwall-artifacts/
        cp ${{ github.workspace }}/openwrt/bin/packages/*/passwall_packages/*.ipk ${{ github.workspace }}/passwall-artifacts/
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "PassWall Version: ${{ steps.version.outputs.version }}" > ${{ github.workspace }}/passwall-artifacts/version.txt
        echo "Build Date: ${{ steps.version.outputs.build_date }}" >> ${{ github.workspace }}/passwall-artifacts/version.txt
        echo "Full Version: ${{ steps.version.outputs.full_version }}" >> ${{ github.workspace }}/passwall-artifacts/version.txt
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd ${{ github.workspace }}/passwall-artifacts
        zip -r CortexA53-Passwall-${{ env.RELEASE_TAG }}.zip .

    # ä½¿ç”¨ Release åŠŸèƒ½å‘å¸ƒæ„å»ºæˆæœ
    - name: Create Release and Upload Assets
      uses: actions/create-release@v1
      id: create_release
      with:
        # ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„æ ‡ç­¾
        tag_name: ${{ env.RELEASE_TAG }}
        # å‘å¸ƒåç§°åŒ…å«ç‰ˆæœ¬å·
        release_name: "CortexA53-PassWall ${{ env.RELEASE_TAG }}"
        # å‘å¸ƒå†…å®¹æ¨¡æ¿
        body: |
          ### ğŸš€ PassWall è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          - **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
          - **ç¼–è¯‘æ—¶é—´**: ${{ steps.version.outputs.build_date }} (åŒ—äº¬æ—¶é—´)
          - **è®¾å¤‡æ¶æ„**: Cortex A53
          - **åŒ…å«ç»„ä»¶**:
            - luci-app-passwall
            - passwall-packages
          - **æ„å»ºè§¦å‘æ–¹å¼**: ${{ github.event_name }}
        # è®¾ç½®ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      with:
        # ä½¿ç”¨ä¸Šä¸€æ­¥åˆ›å»ºçš„Release ID
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        # è¦ä¸Šä¼ çš„æ„å»ºäº§ç‰©
        asset_path: ${{ github.workspace }}/passwall-artifacts/CortexA53-Passwall-${{ env.RELEASE_TAG }}.zip
        # åœ¨Releaseä¸­æ˜¾ç¤ºçš„æ–‡ä»¶å
        asset_name: CortexA53-Passwall-${{ env.RELEASE_TAG }}.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}